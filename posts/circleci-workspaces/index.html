<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="The software blog of Sam Briggs, just another nerd.">
<title>
    CircleCI workspaces - Sam Briggs [software developer]
</title>










<link rel="stylesheet" href="/css/main.min.4321edce0de245f4b1d32680d89ac669940fe5dec17e1791c721d9a0954987b4.css" integrity="sha256-QyHtzg3iRfSx0yaA2JrGaZQP5d7BfheRxyHZoJVJh7Q=" crossorigin="anonymous" media="screen">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CircleCI workspaces"/>
<meta name="twitter:description" content="Correctly attaching CircleCI workspaces"/>

<meta property="og:title" content="CircleCI workspaces" />
<meta property="og:description" content="Correctly attaching CircleCI workspaces" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sambriggs.dev/posts/circleci-workspaces/" />
<meta property="article:published_time" content="2020-02-09T23:30:00+00:00" />
<meta property="article:modified_time" content="2020-02-09T23:30:00+00:00" /><meta property="og:site_name" content="Sam Briggs" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-157531859-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

    
    
    
    <title>
        
        CircleCI workspaces
        
    </title>
</head>

<body>
    
    
    <header class="wrap flex-container">
        <h1>CircleCI workspaces</h1>
    </header>
    
    <main class="wrap">
        
<div class="flex-container">
    
    <aside role="complementary">
        9 Feb 2020 &#183; 305 words
        <div class="tag-container">
            
            
            <span class="tag">
                <a href="/tags/circle-ci/">
                    circle-ci
                </a>
            </span>
            
            
        </div>
    </aside>
    <hr />
    
    
    <article role="article">
        <h2 id="the-problem">The problem</h2>
<p>When I created my CircleCI pipeline in my <a
  href="https://sambriggs.dev/posts/the-birth-of-a-blog/">
  first post
</a>
 I came
unstuck passing the built site from one job to another as a <em>workspace</em>.</p>
<p>This manifested in two ways, where I&rsquo;d made the same mistake in two different jobs.</p>
<h3 id="deployment-issues">Deployment issues</h3>
<p>The deploy job appeared to work correctly, but when I navigated to the site I was greeted with a 404
error:</p>
<p><img src="/github-pages-404.jpg" alt="GitHub pages 404"></p>
<h3 id="html-proofer-internal-link-checks">HTML-proofer internal link checks</h3>
<p>And when I ran the <code>htmlproofer</code> tool on my generated site I was greeted with a slew of errors:</p>
<!-- raw HTML omitted -->
<pre><code>- ./public/public/about/index.html
  *  internally linking to /about, which does not exist (line 0)
     &lt;a href=&quot;/about&quot;&gt;about&lt;/a&gt;
</code></pre><!-- raw HTML omitted -->
<p>In fact, <em>every</em> internal link was flagged as having a target that didn&rsquo;t exist. Fishy&hellip;</p>
<h2 id="the-solution">The solution</h2>
<p>In both cases I had managed to point the respective tools to the wrong directory, based on a misunderstanding
on how workspaces are persisted.</p>
<p>My build job included the following configuration:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - <span style="color:#66d9ef">persist_to_workspace</span>:
      <span style="color:#66d9ef">root</span>: .
      <span style="color:#66d9ef">paths</span>: public
</code></pre></div><p>Which would store a workspace with the structure:</p>
<!-- raw HTML omitted -->
<pre><code>workspace
└── public
    ├── about
    ├── categories
    ...
</code></pre><!-- raw HTML omitted -->
<p>And I&rsquo;d then attach and point at them with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - <span style="color:#66d9ef">attach_workspace</span>:
      <span style="color:#66d9ef">at</span>: ./public
  - <span style="color:#66d9ef">run</span>:
      <span style="color:#66d9ef">name</span>: test HTML files
      <span style="color:#66d9ef">command</span>: htmlproofer ./public --allow-hash-href --check-html
</code></pre></div><p>&hellip;Can you see my error?</p>
<p>After attaching the workspace I had a job containing:</p>
<!-- raw HTML omitted -->
<pre><code>public
└── public
    ├── about
    ├── categories
    ...
</code></pre><!-- raw HTML omitted -->
<p>Meaning that in both jobs I was pointing to a directory <code>public</code> that contained one child directory
<code>public</code>. A sort-of off-by-one directory error.</p>
<p>Updating the config in both cases to mount the workspace to the working directory fixed both issues:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">  - attach_workspace:
<span style="color:#f92672">-     at: ./public
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+     at: .
</span><span style="color:#a6e22e"></span>  - run:
      name: test HTML files
      command: htmlproofer ./public --allow-hash-href --check-html
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<blockquote>
<p>Measure twice, cut once</p>
</blockquote>
<p>As always, the issues that I seem to spend most time on are stupid errors due to not reading
documentation carefully enough!</p>

    </article>
    
    <hr />
    <aside>
        <div>
            <a href="/posts/the-birth-of-a-blog/ ">← The birth of a blog</a>
        </div>
        <div>
            <a href="/posts/detector-dag/introduction/ ">Introduction →</a>
        </div>
    </aside>
</div>


        
        
        <nav role="navigation" class="flex-container bottom-menu">
            
<hr />
<p>


    

    
        
            <a href="/about">about</a>
        
    
    
        
            &#183; 
            <a href="/posts">posts</a>
        
            &#183; 
            <a href="https://github.com/briggySmalls">github</a>
        
    
    &#183; 
    <a href="/">
        home
    </a>

</p>
        </nav>
        
        
    </main>
    
    <footer class="flex-container footer">The software blog of Sam Briggs, just another nerd.</footer>
    
    
</body>

</html>