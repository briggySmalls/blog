<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="The software blog of Sam Briggs, just another nerd.">
<title>
    Power detection - Sam Briggs [software developer]
</title>










<link rel="stylesheet" href="/css/main.min.4321edce0de245f4b1d32680d89ac669940fe5dec17e1791c721d9a0954987b4.css" integrity="sha256-QyHtzg3iRfSx0yaA2JrGaZQP5d7BfheRxyHZoJVJh7Q=" crossorigin="anonymous" media="screen">




<link rel="stylesheet" href="/css/custom.css" integrity="" crossorigin="anonymous" media="screen">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Power detection"/>
<meta name="twitter:description" content="I connected a Raspberry Pi to the UPS-Lite that I&rsquo;d identified in the concepts blog post. Right out of the box I could switch off power and the Pi would stay alive!
I moved on to detecting the power state changes with the Pi: I wanted to send MMQT messages with my AWS IoT client when these events occurred.
Documentation on the UPS-Lite was thin on the ground, but I&rsquo;d found a tweet from the manufacturer that indicated I could detect this on the Pi&rsquo;s GPIO7:"/>

<meta property="og:title" content="Power detection" />
<meta property="og:description" content="I connected a Raspberry Pi to the UPS-Lite that I&rsquo;d identified in the concepts blog post. Right out of the box I could switch off power and the Pi would stay alive!
I moved on to detecting the power state changes with the Pi: I wanted to send MMQT messages with my AWS IoT client when these events occurred.
Documentation on the UPS-Lite was thin on the ground, but I&rsquo;d found a tweet from the manufacturer that indicated I could detect this on the Pi&rsquo;s GPIO7:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sambriggs.dev/posts/detector-dag/power-detection/" />
<meta property="article:published_time" content="2020-04-26T12:48:14+01:00" />
<meta property="article:modified_time" content="2020-04-26T12:48:14+01:00" /><meta property="og:site_name" content="Sam Briggs" /><meta property="og:see_also" content="https://sambriggs.dev/posts/detector-dag/introduction/" /><meta property="og:see_also" content="https://sambriggs.dev/posts/detector-dag/concepts/" /><meta property="og:see_also" content="https://sambriggs.dev/posts/detector-dag/aws-iot/" />



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-157531859-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

    
    
    
    <title>
        
        Power detection
        
    </title>
</head>

<body>
    
    
    <header class="wrap flex-container">
        <h1>Power detection</h1>
    </header>
    
    <main class="wrap">
        
<div class="flex-container">
    
    <aside role="complementary">
        26 Apr 2020 &#183; 406 words
        <div class="tag-container">
            
            
            <span class="tag">
                <a href="/tags/raspberry-pi/">
                    raspberry-pi
                </a>
            </span>
            
            
        </div>
    </aside>
    <hr />
    
    
    <aside role="complementary">
        <div>
            Hey! This post is part of the
            <a href='/series/detector-dag/'>detector-dag</a>
            series. If this post is missing some context you could head there to get caught up.
        </div>
    </aside>
    <hr />
    
    <article role="article">
        <p>I connected a Raspberry Pi to the <a href="https://www.aliexpress.com/item/32954180664.html"
    rel="nofollow external">UPS-Lite</a>
 that I&rsquo;d
identified in the <a href="/posts/detector-dag/concepts/">concepts</a>
 blog post. Right out of the box I could switch
off power and the Pi would stay alive!</p>
<p><img src="/upslite-and-pi.jpg" alt="UPS-Lite schematic"></p>
<p>I moved on to <em>detecting</em> the power state changes with the Pi: I wanted to send MMQT messages
with my <a href="/posts/detector-dag/aws-iot/">AWS IoT client</a>
 when these events occurred.</p>
<p>Documentation on the UPS-Lite was thin on the ground, but I&rsquo;d found a tweet
from the manufacturer that indicated I could detect this on the Pi&rsquo;s GPIO7:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">the i2c pins ,gpio7 and 3V3 <a href="https://t.co/1GP8qrrSwB">pic.twitter.com/1GP8qrrSwB</a></p>&mdash; xiaoj_329 (@Xiaoj329) <a href="https://twitter.com/Xiaoj329/status/1069568475683647488?ref_src=twsrc%5Etfw">December 3, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>I selected the higher-level <a href="https://gpiozero.readthedocs.io/en/stable/#"
    rel="nofollow external">gpiozero</a>
 python library over <a href="https://sourceforge.net/projects/raspberry-gpio-python/"
    rel="nofollow external">RPi.GPIO</a>
. It appears to be the
<a href="https://www.raspberrypi.org/documentation/usage/gpio/python/README.md"
    rel="nofollow external">recommended library</a>
 these days, and critically for me, it has a simple edge detection
API. This allowed me to declaratively assign callbacks to be executed when an input pin changes
value - tidy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> gpiozero <span style="color:#f92672">import</span> DigitalInputDevice  <span style="color:#75715e"># noqa: E501, pylint: disable=import-error,import-outside-toplevel</span>
_POWER_PIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>  <span style="color:#75715e"># gpiozero uses Broadcom pin numbering</span>

power_status_input <span style="color:#f92672">=</span> DigitalInputDevice(_POWER_PIN, bounce_time<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>)
power_status_input<span style="color:#f92672">.</span>when_activated <span style="color:#f92672">=</span> _publish_update
power_status_input<span style="color:#f92672">.</span>when_deactivated <span style="color:#f92672">=</span> _publish_update

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_publish_update</span>(self, device: DigitalInputDevice) <span style="color:#f92672">-&gt;</span> None:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Status changed!&#34;</span>)
</code></pre></div><p>I tore my hair out trying to get that pin detection to work. I found the manufacturer&rsquo;s <a href="https://github.com/linshuqin329/UPS-Lite"
    rel="nofollow external">GitHub repo</a>
,
but the example code demonstrated reading the voltage/capacity of the battery, not the power status.</p>
<p>I double-checked the <a href="https://pinout.xyz/#"
    rel="nofollow external">pin numbering system</a>
, and confirmed it <em>had</em> to be pin BCM4/WiringPi7, not least
because I could <em>see</em> BCM7 wasn&rsquo;t connected to by a pogo pin.</p>
<p>I manually read the pin a few times and whilst knocking it about found the voltage seemed to be floating:
sometimes it was high, and sometimes low. Going <em>really</em> spare I got my multi-meter out and confirmed
it.</p>
<p>I studied the owners manual, written in Chinese, pouring over the same wiring schematic I&rsquo;d found in
the tweet: everything looked kosher.</p>
<p>Finally, I found a <a href="https://github.com/linshuqin329/UPS-Lite/issues/1"
    rel="nofollow external">translated manual</a>
 that revealed my error:</p>
<blockquote>
<p>Also UPS-Lite insertion detecting function with a power adaptor, the insertion of the power pi io4
(BCM number) detects the high level, when pulled low, enabling the weld shorting function requires two
back of the UPS disc, as shown below in detail.</p>
</blockquote>
<p><img src="/upslite-pads.png" alt="UPS-Lite solder pads"></p>
<p>I needed to short the two solder pads on the back of the board to have the pogo pin carry the power
status signal! If my electronics knowledge had been better this is actually obvious from the schematic:</p>
<p><img src="/upslite-schematic.png" alt="UPS-Lite schematic"></p>
<p>&hellip;I&rsquo;m telling you, I felt like a right fool.</p>

    </article>
    
    <hr />
    <aside>
        <div>
            <a href="/posts/python-config/ ">‚Üê Python Config</a>
        </div>
        <div>
            
        </div>
    </aside>
</div>


        
        
        <nav role="navigation" class="flex-container bottom-menu">
            
<hr />
<p>


    

    
        
            <a href="/about">about</a>
        
    
    
        
            &#183; 
            <a href="/posts">posts</a>
        
            &#183; 
            <a href="https://github.com/briggySmalls">github</a>
        
    
    &#183; 
    <a href="/">
        home
    </a>

</p>
        </nav>
        
        
    </main>
    
    <footer class="flex-container footer">The software blog of Sam Briggs, just another nerd.</footer>
    
    
</body>

</html>